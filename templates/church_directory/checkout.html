{% extends 'church_directory/base.html' %}
{% load static %}

{% block title %}Checkout - {{ tier.name }} Plan{% endblock %}

{% block extra_css %}
<style>
    .checkout-step {
        @apply flex items-center space-x-4 mb-8;
    }
    .step-number {
        @apply w-8 h-8 rounded-full bg-blue-600 text-white text-sm font-semibold flex items-center justify-center flex-shrink-0;
    }
    .step-content {
        @apply flex-1;
    }
    .coupon-input {
        transition: all 0.3s ease;
    }
    .coupon-success {
        @apply border-green-500 bg-green-50;
    }
    .coupon-error {
        @apply border-red-500 bg-red-50;
    }
</style>
{% endblock %}

{% block content %}
<!-- Checkout Header -->
<section class="bg-gray-50 py-12">
    <div class="container-width">
        <div class="text-center">
            <h1 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-4">
                Complete Your Subscription
            </h1>
            <p class="text-lg text-gray-600">
                You're just one step away from connecting your church community
            </p>
        </div>
    </div>
</section>

<!-- Checkout Content -->
<section class="section-padding">
    <div class="container-width">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
            <!-- Left Column - Form -->
            <div class="lg:col-span-2">
                <form method="post" id="checkout-form">
                    {% csrf_token %}
                    
                    <!-- Step 1: Plan Selection -->
                    <div class="checkout-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h2 class="text-xl font-semibold text-gray-900 mb-2">Selected Plan</h2>
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="text-lg font-semibold text-blue-900">{{ tier.name }} Plan</h3>
                                        <p class="text-blue-700 text-sm mt-1">{{ tier.description }}</p>
                                        <p class="text-blue-800 font-medium mt-2">{{ tier.users_display }} users</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-2xl font-bold text-blue-900">
                                            $<span id="display-price">{{ base_price|floatformat:0 }}</span>
                                        </div>
                                        <div class="text-sm text-blue-700">
                                            /{% if billing_period == 'annual' %}year{% else %}month{% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 2: Coupon Code -->
                    <div class="checkout-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h2 class="text-xl font-semibold text-gray-900 mb-4">Coupon Code (Optional)</h2>
                            <div class="flex space-x-4">
                                <div class="flex-1">
                                    <input 
                                        type="text" 
                                        id="coupon-code" 
                                        name="coupon_code"
                                        value="{{ coupon_code|default:'' }}"
                                        placeholder="Enter coupon code"
                                        class="coupon-input form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 uppercase"
                                        style="text-transform: uppercase;"
                                    >
                                    <div id="coupon-message" class="mt-2 text-sm hidden"></div>
                                </div>
                                <button 
                                    type="button" 
                                    id="apply-coupon" 
                                    class="btn-secondary whitespace-nowrap"
                                >
                                    Apply
                                </button>
                            </div>
                            {% if coupon %}
                            <div class="mt-4 bg-green-50 border border-green-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <div>
                                        <p class="text-green-800 font-medium">Coupon Applied: {{ coupon.code }}</p>
                                        <p class="text-green-700 text-sm">{{ coupon.description }}</p>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Step 3: Church Information -->
                    <div class="checkout-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h2 class="text-xl font-semibold text-gray-900 mb-4">Church Information</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="{{ form.email.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        {{ form.email.label }}
                                    </label>
                                    {{ form.email }}
                                    {% if form.email.errors %}
                                        <div class="text-red-600 text-sm mt-1">{{ form.email.errors|first }}</div>
                                    {% endif %}
                                </div>
                                
                                <div>
                                    <label for="{{ form.church_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        {{ form.church_name.label }}
                                    </label>
                                    {{ form.church_name }}
                                    {% if form.church_name.errors %}
                                        <div class="text-red-600 text-sm mt-1">{{ form.church_name.errors|first }}</div>
                                    {% endif %}
                                </div>
                                
                                <div>
                                    <label for="{{ form.contact_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        {{ form.contact_name.label }}
                                    </label>
                                    {{ form.contact_name }}
                                    {% if form.contact_name.errors %}
                                        <div class="text-red-600 text-sm mt-1">{{ form.contact_name.errors|first }}</div>
                                    {% endif %}
                                </div>
                                
                                <div>
                                    <label for="{{ form.phone.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        {{ form.phone.label }}
                                    </label>
                                    {{ form.phone }}
                                    {% if form.phone.errors %}
                                        <div class="text-red-600 text-sm mt-1">{{ form.phone.errors|first }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 4: Terms and Conditions -->
                    <div class="checkout-step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <h2 class="text-xl font-semibold text-gray-900 mb-4">Terms & Conditions</h2>
                            <div class="flex items-start space-x-3">
                                {{ form.agree_terms }}
                                <label for="{{ form.agree_terms.id_for_label }}" class="text-sm text-gray-700 leading-5">
                                    {{ form.agree_terms.label }}
                                </label>
                            </div>
                            {% if form.agree_terms.errors %}
                                <div class="text-red-600 text-sm mt-1 ml-7">{{ form.agree_terms.errors|first }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Submit Button -->
                    <div class="pt-8 border-t border-gray-200">
                        <button type="submit" class="btn-primary w-full lg:w-auto lg:px-12">
                            Continue to Payment
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Right Column - Order Summary -->
            <div class="lg:col-span-1">
                <div class="bg-gray-50 rounded-xl p-6 sticky top-8">
                    <h3 class="text-lg font-semibold text-gray-900 mb-6">Order Summary</h3>
                    
                    <div class="space-y-4">
                        <!-- Plan Details -->
                        <div class="flex justify-between">
                            <span class="text-gray-700">{{ tier.name }} Plan</span>
                            <span class="font-medium text-gray-900">
                                {% if billing_period == 'annual' %}Annual{% else %}Monthly{% endif %}
                            </span>
                        </div>
                        
                        <div class="flex justify-between">
                            <span class="text-gray-700">Users included</span>
                            <span class="font-medium text-gray-900">{{ tier.users_display }}</span>
                        </div>
                        
                        <hr class="border-gray-200">
                        
                        <!-- Pricing Breakdown -->
                        <div class="flex justify-between">
                            <span class="text-gray-700">Base price</span>
                            <span class="font-medium text-gray-900" id="summary-base-price">
                                ${{ base_price|floatformat:2 }}
                            </span>
                        </div>
                        
                        {% if discount_amount > 0 %}
                        <div class="flex justify-between text-green-600">
                            <span>Discount{% if coupon %} ({{ coupon.code }}){% endif %}</span>
                            <span id="summary-discount">-${{ discount_amount|floatformat:2 }}</span>
                        </div>
                        {% endif %}
                        
                        <hr class="border-gray-200">
                        
                        <div class="flex justify-between text-lg font-semibold">
                            <span class="text-gray-900">Total</span>
                            <span class="text-gray-900" id="summary-total">
                                ${{ final_price|floatformat:2 }}
                            </span>
                        </div>
                        
                        <div class="text-xs text-gray-600 mt-4">
                            {% if billing_period == 'annual' %}
                            Billed annually. You can cancel anytime.
                            {% else %}
                            Billed monthly. You can cancel anytime.
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Features Included -->
                    <div class="mt-8">
                        <h4 class="text-sm font-semibold text-gray-900 mb-3">What's Included:</h4>
                        <ul class="space-y-2">
                            {% for feature in tier.features|slice:":5" %}
                            <li class="flex items-start text-sm text-gray-700">
                                <svg class="w-4 h-4 text-green-500 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                {{ feature }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    
                    <!-- Support Info -->
                    <div class="mt-8 p-4 bg-blue-50 rounded-lg">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-blue-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"></path>
                            </svg>
                            <span class="text-sm text-blue-900 font-medium">Need help?</span>
                        </div>
                        <p class="text-sm text-blue-800 mt-1">
                            Contact us at <a href="mailto:{% if config %}{{ config.support_email }}{% else %}support@verionlabs.com{% endif %}" class="underline">{% if config %}{{ config.support_email }}{% else %}support@verionlabs.com{% endif %}</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const couponInput = document.getElementById('coupon-code');
    const applyButton = document.getElementById('apply-coupon');
    const couponMessage = document.getElementById('coupon-message');
    
    // Coupon application
    applyButton.addEventListener('click', function() {
        const couponCode = couponInput.value.trim().toUpperCase();
        
        if (!couponCode) {
            showCouponMessage('Please enter a coupon code.', 'error');
            return;
        }
        
        // Show loading state
        applyButton.disabled = true;
        applyButton.textContent = 'Applying...';
        
        // Make AJAX request to validate coupon
        fetch('{% url "church_directory:validate_coupon" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                coupon_code: couponCode,
                tier_id: {{ tier.id }},
                billing_period: '{{ billing_period }}'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.valid) {
                showCouponMessage(data.message, 'success');
                updatePricing(data.discount_amount, data.final_price);
                
                // Redirect with coupon code
                const currentUrl = new URL(window.location);
                currentUrl.searchParams.set('coupon', couponCode);
                window.location.href = currentUrl.toString();
            } else {
                showCouponMessage(data.message, 'error');
            }
        })
        .catch(error => {
            showCouponMessage('Error validating coupon. Please try again.', 'error');
        })
        .finally(() => {
            // Reset button state
            applyButton.disabled = false;
            applyButton.textContent = 'Apply';
        });
    });
    
    // Enter key handling for coupon input
    couponInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            applyButton.click();
        }
    });
    
    function showCouponMessage(message, type) {
        couponMessage.textContent = message;
        couponMessage.className = `mt-2 text-sm ${type === 'success' ? 'text-green-600' : 'text-red-600'}`;
        couponMessage.classList.remove('hidden');
        
        // Update input styling
        couponInput.className = `coupon-input form-input w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 uppercase ${
            type === 'success' ? 'coupon-success' : type === 'error' ? 'coupon-error' : 'border-gray-300'
        }`;
    }
    
    function updatePricing(discountAmount, finalPrice) {
        // Update display price in plan section
        document.getElementById('display-price').textContent = Math.round(finalPrice);
        
        // Update order summary
        document.getElementById('summary-total').textContent = '$' + finalPrice.toFixed(2);
        
        // Show discount row if not already shown
        if (discountAmount > 0) {
            const summaryDiscount = document.getElementById('summary-discount');
            if (summaryDiscount) {
                summaryDiscount.textContent = '-$' + discountAmount.toFixed(2);
            }
        }
    }
});
</script>
{% endblock %}